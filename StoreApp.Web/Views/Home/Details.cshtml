@model ProductViewModel
@using System.Globalization

<div class="container my-5">
    <div class="row g-5 align-items-start">
        <div class="col-md-6 text-center">
            <div class="border rounded shadow-sm p-3 bg-white position-relative">

                @if (User.Identity.IsAuthenticated)
                {
                    <button type="button"
                        class="btn btn-light border rounded-circle position-absolute top-0 end-0 m-2 shadow-sm favorite-btn"
                        onclick="toggleFavorite(@Model.Id, this)">
                        <i class="bi @(Model.IsFavorited ? "bi-heart-fill text-danger" : "bi-heart")"></i>
                    </button>
                }

                <img src="~/img/products/@Model.Image" class="img-fluid rounded" alt="@Model.Name"
                    style="max-height: 400px; object-fit: contain;" />
            </div>
        </div>

        <div class="col-md-6">
            <h2 class="fw-bold">@Model.Name</h2>

            <div class="mb-2 d-flex gap-2">
                @if (Model.IsFeatured)
                {
                    <span class="badge rounded-pill bg-danger">
                        <i class="bi bi-fire me-1"></i> Öne Çıkan
                    </span>
                }
                @if (Model.IsBestSeller)
                {
                    <span class="badge rounded-pill bg-warning text-dark">
                        <i class="bi bi-star-fill me-1"></i> Çok Satan
                    </span>
                }
            </div>

            <div class="my-3">
                <span class="text-warning fs-5">
                    ★ ★ ★ ★ ☆
                </span>
                <small class="text-muted">(12 Değerlendirme)</small>
            </div>

            <h3 class="text-danger fw-bold mb-3">@Model.Price.ToString("C", CultureInfo.GetCultureInfo("tr-TR"))</h3>

            <p class="text-muted">@Model.Description</p>

            <div class="mb-2 text-success small">
                <i class="bi bi-truck"></i> Ücretsiz Kargo &nbsp; | &nbsp;
                <i class="bi bi-shield-lock"></i> Güvenli Ödeme
            </div>

            @if (Model.ProductCategories?.Any() == true)
            {
                <div class="mb-3">
                    <strong>Kategoriler:</strong>
                    @foreach (var pc in Model.ProductCategories)
                    {
                        <span class="badge bg-secondary me-1">@pc.Category?.Name</span>
                    }
                </div>
            }

            <div class="d-grid gap-2 d-md-block">
                @if (Model.Stock > 0)
                {
                    <form method="post" class="d-inline" asp-page="/Cart">
                        <input type="hidden" asp-for="@Model.Id" name="Id" />
                        <button type="submit" class="btn btn-dark btn-lg px-4 mt-2">
                            <i class="bi bi-cart-plus me-1"></i> Sepete Ekle
                        </button>
                    </form>
                }
                else
                {
                    <button class="btn btn-secondary btn-lg px-4 mt-1" disabled>
                        <i class="bi bi-x-circle me-1"></i> Tükendi
                    </button>
                }

                <a href="/" class="btn btn-outline-secondary btn-lg px-4 mx-2">
                    <i class="bi bi-arrow-left"></i> Geri Dön
                </a>
            </div>
        </div>
    </div>
</div>

<hr />

@await Component.InvokeAsync("SimilarProducts", new { productId = Model.Id })

@section Scripts {
    <script>
        function toggleFavorite(productId, btn) {
            fetch('/Account/ToggleFavorite', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ productId })
            })
                .then(res => {
                    if (!res.ok) {
                        if (res.status === 401) {
                            window.location.href = "/Account/Login";
                        }
                        throw new Error("Sunucu hatası");
                    }
                    return res.json();
                })
                .then(data => {
                    const icon = btn.querySelector('i');
                    if (data.favorited) {
                        icon.classList.remove('bi-heart');
                        icon.classList.add('bi-heart-fill', 'text-danger');
                    } else {
                        icon.classList.remove('bi-heart-fill', 'text-danger');
                        icon.classList.add('bi-heart');
                    }
                })
                .catch(err => {
                    console.error("Favori işlemi başarısız:", err);
                });
        }
    </script>
}
